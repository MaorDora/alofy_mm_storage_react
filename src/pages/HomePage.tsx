// src/pages/HomePage.tsx
import { useMemo } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useDatabase } from '../contexts/DatabaseContext';
import './HomePage.css'; 
import type { Activity, EquipmentItem } from '../types';

// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×¤×•×¨××˜ ×ª××¨×™×š (×œ×œ× ×©×™× ×•×™)
const formatActivityDate = (dateString: string) => {
  const date = new Date(dateString);
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  if (date.toDateString() === today.toDateString()) {
    return `×”×™×•×, ${date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}`;
  }
  if (date.toDateString() === tomorrow.toDateString()) {
    return `××—×¨, ${date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}`;
  }
  return date.toLocaleDateString('he-IL', { day: '2-digit', month: 'short', year: 'numeric' });
};

function HomePage() {
  const { currentUser, equipment, activities, isLoading } = useDatabase(); 
  const navigate = useNavigate(); 

  // --- 1. ×¢×“×›×•×Ÿ ×—×™×©×•×‘ × ×ª×•× ×™ "×“×•×¨×© ×˜×™×¤×•×œ" ---
  const attentionItems = useMemo(() => {
    // ×”×’×“×¨×ª ×ª××¨×™×š ×”×¡×£ ×œ×•×•×™×“×•× (×œ×¤× ×™ 7 ×™××™×)
    const today = new Date();
    const validateThreshold = new Date(today.setDate(today.getDate() - 7));

    let broken = 0;
    let repair = 0;
    let loaned = 0;
    let needsValidation = 0;

    equipment.forEach(item => {
      // ×¡×¤×™×¨×ª ×¡×˜×˜×•×¡×™×
      if (item.status === 'broken') broken++;
      if (item.status === 'repair') repair++;
      if (item.status === 'loaned') loaned++;
      
      // ×¡×¤×™×¨×ª ×•×•×™×“×•×
      if (new Date(item.lastCheckDate) < validateThreshold) {
        needsValidation++;
      }
    });
    
    return [
      // --- ×”×•×¡×¤×ª ×”×©×•×¨×” ×”×—×“×©×” ---
      { id: 'validate', text: '×¤×¨×™×˜×™× ×“×•×¨×©×™ ×•×•×™×“×•×', icon: 'ğŸ—“ï¸', iconClass: 'icon-orange', count: needsValidation, path: '/items/filter/validate' },
      // --- ×©××¨ ×”×©×•×¨×•×ª ---
      { id: 'broken', text: '×¤×¨×™×˜×™× ×œ× ×›×©×™×¨×™×', icon: '!', iconClass: 'icon-red', count: broken, path: '/items/filter/broken' },
      { id: 'repair', text: '×¤×¨×™×˜×™× ×‘×ª×™×§×•×Ÿ', icon: 'ğŸ”§', iconClass: 'icon-orange', count: repair, path: '/items/filter/repair' },
      { id: 'loaned', text: '×”×©××œ×•×ª ×©×˜×¨× ×”×•×—×–×¨×•', icon: 'â†’', iconClass: 'icon-orange', count: loaned, path: '/items/filter/loaned' }
    ];
  }, [equipment]);
  // --- ×¡×•×£ ×”×¢×“×›×•×Ÿ ---

  // ×—×™×©×•×‘ "×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª" (×œ×œ× ×©×™× ×•×™)
  const upcomingActivities = useMemo(() => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    
    return activities
      .filter(act => new Date(act.date) >= today) 
      .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()) 
      .slice(0, 3); 
  }, [activities]);

  const handleAttentionClick = (path: string) => {
    navigate(path);
  };
  
  if (isLoading && equipment.length === 0) {
     return (
       <div>
         <div className="page-header">
           <h1 className="main-title">×©×œ×•×, {currentUser?.name || '...'}</h1>
           <div className="subtitle">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
         </div>
       </div>
     );
  }

  return (
    <div>
      <div className="page-header">
        <h1 className="main-title">×©×œ×•×, {currentUser?.name || '...'}</h1>
        <div className="subtitle">×¡×§×™×¨×” ×›×œ×œ×™×ª</div>
      </div>
      <div className="container">
        {/* --- ×›×¨×˜×™×¡ "×“×•×¨×© ×˜×™×¤×•×œ" --- */}
        <div className="dashboard-card" id="attention-card">
          <div className="card-header">
            <h2 className="card-title">×“×•×¨×© ×˜×™×¤×•×œ</h2>
          </div>
          <div className="card-content">
            {/* 2. ×”×¨×©×™××” ×ª×¨×•× ×“×¨ ××•×˜×•××˜×™×ª ×¢× ×”×¤×¨×™×˜ ×”×—×“×© ×©× ×•×¡×£ */}
            {attentionItems.map(item => (
              <div 
                key={item.id}
                className="attention-item" 
                onClick={() => handleAttentionClick(item.path)}
              >
                <div className="attention-details">
                  <span className={`attention-icon ${item.iconClass}`}>{item.icon}</span>
                  <span className="attention-text">{item.text}</span>
                </div>
                <div className="attention-count">{item.count} <span className="chevron">&#9664;</span></div>
              </div>
            ))}
          </div>
        </div>

        {/* --- ×›×¨×˜×™×¡ "×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª" (×œ×œ× ×©×™× ×•×™) --- */}
        <div className="dashboard-card" id="upcoming-card">
          <div className="card-header">
            <h2 className="card-title">×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª</h2>
          </div>
          <div className="card-content">
            {upcomingActivities.length === 0 ? (
              <p style={{ color: 'var(--text-secondary)', textAlign: 'center', padding: '10px 0' }}>
                ××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×§×¨×•×‘×•×ª.
              </p>
            ) : (
              upcomingActivities.map(activity => {
                const total = activity.equipmentRequiredIds.length + activity.equipmentMissingIds.length;
                const available = activity.equipmentRequiredIds.length;
                const hasGaps = available < total;
                
                return (
                  <Link 
                    to={`/activities/${activity.id}`} 
                    key={activity.id} 
                    className="activity-list-item"
                  >
                    <div className="activity-details">
                      <span className="activity-title">{activity.name}</span>
                      <span className="activity-time">{formatActivityDate(activity.date)}</span>
                    </div>
                    <div className={`activity-status ${hasGaps ? 'status-gaps' : 'status-ready'}`}>
                      {hasGaps ? (
                        <div>
                          <span><span>&times;</span> ×¤×¢×¨×™× ×§×™×™××™×</span>
                          <span className="status-subtitle">×—×¡×¨×™× {total - available} ×¤×¨×™×˜×™×</span>
                        </div>
                      ) : (
                        <span><span>&#10003;</span> ××•×›×Ÿ ×œ×™×¦×™××”</span>
                      )}
                    </div>
                  </Link>
                );
              })
            )}
          </div>
        </div>
        
      </div>
    </div>
  );
}
export default HomePage;